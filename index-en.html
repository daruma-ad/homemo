<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Homemo</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="theme-color" content="#f39c12">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            padding: 20px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #f39c12, #e74c3c, #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
        }

        /* Input Section */
        .input-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .time-display {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 900;
            color: #f39c12;
            margin-bottom: 16px;
            text-shadow: 0 2px 10px rgba(243, 156, 18, 0.3);
        }

        .task-input-wrapper {
            position: relative;
            margin-bottom: 16px;
        }

        .task-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1.1rem;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.3s;
        }

        .task-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .task-input:focus {
            outline: none;
            border-color: #f39c12;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.2);
        }

        /* Quick Task Buttons */
        .quick-tasks {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .quick-task-btn {
            padding: 10px 14px;
            border: none;
            border-radius: 14px;
            color: #fff;
            font-size: 0.85rem;
            font-family: 'Noto Sans JP', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            position: relative;
        }

        .quick-task-btn:hover {
            transform: translateY(-2px);
        }

        .quick-task-btn:active {
            transform: scale(0.95);
        }

        .quick-task-btn .emoji {
            font-size: 1.1rem;
        }

        .quick-task-btn .label {
            font-weight: 700;
        }

        /* Color Presets */
        .color-red {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
        }

        .color-blue {
            background: linear-gradient(145deg, #3498db, #2980b9);
        }

        .color-green {
            background: linear-gradient(145deg, #2ecc71, #27ae60);
        }

        .color-purple {
            background: linear-gradient(145deg, #9b59b6, #8e44ad);
        }

        .color-orange {
            background: linear-gradient(145deg, #e67e22, #d35400);
        }

        .color-pink {
            background: linear-gradient(145deg, #fd79a8, #e84393);
        }

        .color-teal {
            background: linear-gradient(145deg, #00cec9, #00b894);
        }

        .color-yellow {
            background: linear-gradient(145deg, #fdcb6e, #f39c12);
        }

        /* Add Button */
        .add-task-btn {
            padding: 10px 14px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            font-family: 'Noto Sans JP', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .add-task-btn:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* Done Button */
        .complete-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 14px;
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            color: #fff;
            font-size: 1.3rem;
            font-weight: 900;
            font-family: 'Noto Sans JP', sans-serif;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(231, 76, 60, 0.4);
            transition: all 0.2s;
        }

        .complete-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(231, 76, 60, 0.5);
        }

        .complete-btn:active {
            transform: scale(0.98);
        }

        .complete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Message */
        .message-box {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .message {
            font-size: 1.1rem;
            font-weight: 700;
            line-height: 1.5;
            padding: 14px 20px;
            background: rgba(243, 156, 18, 0.2);
            border-radius: 14px;
            border-left: 4px solid #f39c12;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s ease;
            text-align: center;
        }

        .message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Timeline Section */
        .timeline-section {
            margin-top: 10px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .timeline-title {
            font-size: 1rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.8);
        }

        .timeline-count {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .timeline-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .copy-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            font-family: 'Noto Sans JP', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .copy-btn.copied {
            background: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
        }

        /* Timeline Item */
        .timeline {
            position: relative;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 24px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.1);
        }

        .timeline-item {
            position: relative;
            padding-left: 60px;
            padding-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .timeline-dot {
            position: absolute;
            left: 16px;
            top: 4px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(145deg, #f39c12, #e67e22);
            box-shadow: 0 2px 10px rgba(243, 156, 18, 0.4);
        }

        .timeline-time {
            font-size: 0.85rem;
            font-weight: 700;
            color: #f39c12;
            margin-bottom: 4px;
        }

        .timeline-task {
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 6px;
        }

        .timeline-praise {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: inline-block;
        }

        .timeline-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .timeline-content {
            flex: 1;
        }

        .delete-log-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.3);
            font-size: 1rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .delete-log-btn:hover {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .timeline-empty {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.95rem;
        }

        /* Date Tabs */
        .date-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .date-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            font-family: 'Noto Sans JP', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .date-tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .date-tab.active {
            background: linear-gradient(145deg, #f39c12, #e67e22);
            color: #fff;
            font-weight: 700;
        }

        .date-tab .log-count {
            font-size: 0.75rem;
            margin-left: 4px;
            opacity: 0.8;
        }

        /* Stats */
        .stats {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 14px 16px;
            border-radius: 12px;
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 1.6rem;
            font-weight: 900;
            color: #f39c12;
        }

        .stat-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 2px;
        }

        /* Settings Section */
        .settings-toggle {
            text-align: center;
            margin-bottom: 10px;
        }

        .settings-toggle button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 8px 16px;
        }

        .settings-section {
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: none;
        }

        .settings-section.show {
            display: block;
        }

        .settings-section input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            color: #fff;
            font-size: 0.9rem;
            margin-top: 6px;
        }

        .settings-section input:focus {
            outline: none;
            border-color: #f39c12;
        }

        .settings-section label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: linear-gradient(145deg, #1e2a4a, #162035);
            border-radius: 24px;
            padding: 24px;
            width: 100%;
            max-width: 360px;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: translateY(0);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
        }

        .modal-field {
            margin-bottom: 20px;
        }

        .modal-field label {
            display: block;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 10px;
        }

        .modal-field input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .modal-field input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .modal-field input:focus {
            outline: none;
            border-color: #f39c12;
        }

        /* Emoji Picker */
        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .emoji-option {
            aspect-ratio: 1;
            border: 2px solid transparent;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .emoji-option.selected {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
        }

        /* Color Picker */
        .color-picker {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .color-option {
            aspect-ratio: 1;
            border: 3px solid transparent;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #fff;
        }

        /* Modal Buttons */
        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            font-family: 'Noto Sans JP', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: linear-gradient(145deg, #f39c12, #e67e22);
            color: #fff;
        }

        .modal-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .modal-btn.danger {
            background: rgba(231, 76, 60, 0.8);
            color: #fff;
            flex: 0.5;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            animation: confetti-fall 1s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(0) rotate(0deg);
            }

            100% {
                opacity: 0;
                transform: translateY(300px) rotate(720deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üéâ Homemo</h1>
            <p class="subtitle">Log tasks and get praised!</p>
        </div>

        <!-- Input Section -->
        <div class="input-section">
            <div class="time-display" id="currentTime">12:30</div>

            <div class="task-input-wrapper">
                <input type="text" class="task-input" id="taskInput" placeholder="Enter what you just did...">
            </div>

            <div class="quick-tasks" id="quickTasks">
                <!-- Dynamically generated -->
            </div>

            <button class="complete-btn" id="completeBtn">Done! üí™</button>
        </div>

        <!-- Message -->
        <div class="message-box">
            <p class="message" id="message"></p>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="todayCount">0</div>
                <div class="stat-label">Today's Wins</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Total</div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="timeline-section">
            <div class="date-tabs" id="dateTabs">
                <!-- Dynamically generated -->
            </div>
            <div class="timeline-header">
                <span class="timeline-title" id="timelineTitle">üìÖ Today's Log</span>
                <div class="timeline-actions">
                    <button class="copy-btn" id="copyBtn" title="Copy in Markdown format">üìã Copy</button>
                    <span class="timeline-count" id="logCount">0 entries</span>
                </div>
            </div>
            <div class="timeline" id="timeline">
                <div class="timeline-empty">No logs yet<br>Complete a task to record it!</div>
            </div>
        </div>

        <!-- Settings -->
        <div class="settings-toggle">
            <button id="settingsToggle">‚öôÔ∏è Settings</button>
        </div>
        <div class="settings-section" id="settingsSection">
            <label for="apiKey">üîë Gemini API Key</label>
            <input type="password" id="apiKey" placeholder="AIza...">
        </div>
    </div>

    <!-- Task Add/Edit Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <h2 class="modal-title" id="modalTitle">Add Task</h2>

            <div class="modal-field">
                <label>Task Name</label>
                <input type="text" id="taskNameInput" placeholder="e.g. Finished workout">
            </div>

            <div class="modal-field">
                <label>Icon</label>
                <div class="emoji-picker" id="emojiPicker"></div>
            </div>

            <div class="modal-field">
                <label>Color</label>
                <div class="color-picker" id="colorPicker"></div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn secondary" id="cancelBtn">Cancel</button>
                <button class="modal-btn danger" id="deleteBtn" style="display: none;">Delete</button>
                <button class="modal-btn primary" id="saveBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Emoji List
        const EMOJIS = ['üí™', 'üìö', 'üíä', 'üíß', 'üèÉ', 'üßò', '‚úçÔ∏è', 'üéß', 'üåø', 'üßπ', 'ü•±', 'üçé',
            '‚òï', 'üéØ', 'üî•', '‚≠ê', 'üíé', 'üåô', 'üéµ', 'üíª', 'üìù', 'üé®', 'üö¥', 'üèãÔ∏è'];

        // Color List
        const COLORS = ['red', 'blue', 'green', 'purple', 'orange', 'pink', 'teal', 'yellow'];

        // Default Tasks
        const DEFAULT_QUICK_TASKS = [
            { id: 'workout', emoji: 'üí™', label: 'Workout', color: 'red' },
            { id: 'study', emoji: 'üìö', label: 'Study', color: 'blue' },
            { id: 'medicine', emoji: 'üíä', label: 'Meds', color: 'green' },
            { id: 'water', emoji: 'üíß', label: 'Water', color: 'purple' },
            { id: 'stretch', emoji: 'üßò', label: 'Stretch', color: 'teal' },
        ];

        // State
        let quickTasks = [];
        let todayLogs = [];
        let allLogs = {}; // Daily logs { '2026-02-03': [...], '2026-02-02': [...] }
        let selectedDate = null; // Currently selected date
        let editingTaskId = null;
        let selectedEmoji = 'üí™';
        let selectedColor = 'red';

        // DOM Elements
        const currentTimeEl = document.getElementById('currentTime');
        const taskInput = document.getElementById('taskInput');
        const quickTasksEl = document.getElementById('quickTasks');
        const completeBtn = document.getElementById('completeBtn');
        const messageEl = document.getElementById('message');
        const todayCountEl = document.getElementById('todayCount');
        const totalCountEl = document.getElementById('totalCount');
        const timelineEl = document.getElementById('timeline');
        const logCountEl = document.getElementById('logCount');
        const apiKeyInput = document.getElementById('apiKey');
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsSection = document.getElementById('settingsSection');
        const modal = document.getElementById('taskModal');
        const modalTitle = document.getElementById('modalTitle');
        const taskNameInput = document.getElementById('taskNameInput');
        const emojiPicker = document.getElementById('emojiPicker');
        const colorPicker = document.getElementById('colorPicker');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const copyBtn = document.getElementById('copyBtn');
        const dateTabsEl = document.getElementById('dateTabs');
        const timelineTitleEl = document.getElementById('timelineTitle');

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            currentTimeEl.textContent = `${hours}:${minutes}`;
        }

        // Today's date key (local time)
        function getTodayKey() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Load data
        function loadData() {
            // Quick tasks
            const savedTasks = localStorage.getItem('quickTasks');
            quickTasks = savedTasks ? JSON.parse(savedTasks) : [...DEFAULT_QUICK_TASKS];

            // All logs
            allLogs = JSON.parse(localStorage.getItem('allLogs') || '{}');

            // Today's logs
            const today = getTodayKey();
            selectedDate = today;

            // Migration for old todayLogs data
            const oldTodayLogs = localStorage.getItem('todayLogs');
            const savedDate = localStorage.getItem('lastDate');
            if (oldTodayLogs && savedDate) {
                const parsedOldLogs = JSON.parse(oldTodayLogs);
                if (parsedOldLogs.length > 0) {
                    allLogs[savedDate] = parsedOldLogs;
                    localStorage.setItem('allLogs', JSON.stringify(allLogs));
                }
            }

            todayLogs = allLogs[today] || [];
            localStorage.setItem('lastDate', today);

            // Stats
            const totalCount = parseInt(localStorage.getItem('totalCount')) || 0;
            todayCountEl.textContent = todayLogs.length;
            totalCountEl.textContent = totalCount;

            // Restore API key
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey) apiKeyInput.value = savedKey;

            renderQuickTasks();
            renderDateTabs();
            renderTimeline();
        }

        // Render date tabs
        function renderDateTabs() {
            const today = getTodayKey();
            const dates = Object.keys(allLogs).sort().reverse();

            // Add today to the front if not present
            if (!dates.includes(today)) {
                dates.unshift(today);
            } else {
                // Move today to the front
                const idx = dates.indexOf(today);
                dates.splice(idx, 1);
                dates.unshift(today);
            }

            // Show only recent 7 days
            const recentDates = dates.slice(0, 7);

            dateTabsEl.innerHTML = recentDates.map(date => {
                const logs = allLogs[date] || [];
                const isToday = date === today;
                const isActive = date === selectedDate;
                const label = isToday ? 'Today' : formatDateLabel(date);
                return `
          <button class="date-tab ${isActive ? 'active' : ''}" onclick="selectDate('${date}')">
            ${label}<span class="log-count">(${logs.length})</span>
          </button>
        `;
            }).join('');
        }

        // Format date label
        function formatDateLabel(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (dateStr === yesterday.toISOString().split('T')[0]) {
                return 'Yesterday';
            }
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        // Select date
        function selectDate(date) {
            selectedDate = date;
            const today = getTodayKey();

            if (date === today) {
                timelineTitleEl.textContent = "üìÖ Today's Log";
            } else {
                timelineTitleEl.textContent = `üìÖ ${formatDateLabel(date)}'s Log`;
            }

            renderDateTabs();
            renderTimeline();
        }

        // Render quick tasks
        function renderQuickTasks() {
            quickTasksEl.innerHTML = '';

            quickTasks.forEach(task => {
                const btn = document.createElement('button');
                btn.className = `quick-task-btn color-${task.color}`;
                btn.innerHTML = `<span class="emoji">${task.emoji}</span><span class="label">${task.label}</span>`;
                btn.addEventListener('click', () => {
                    taskInput.value = `${task.emoji} Done ${task.label}`;
                    taskInput.focus();
                });
                btn.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    openEditModal(task.id);
                });
                // Long press support
                let pressTimer;
                btn.addEventListener('touchstart', () => {
                    pressTimer = setTimeout(() => openEditModal(task.id), 500);
                });
                btn.addEventListener('touchend', () => clearTimeout(pressTimer));
                btn.addEventListener('touchmove', () => clearTimeout(pressTimer));

                quickTasksEl.appendChild(btn);
            });

            // Add button
            const addBtn = document.createElement('button');
            addBtn.className = 'add-task-btn';
            addBtn.innerHTML = '<span>‚ûï</span><span>Add</span>';
            addBtn.addEventListener('click', openAddModal);
            quickTasksEl.appendChild(addBtn);
        }

        // Render timeline
        function renderTimeline() {
            const today = getTodayKey();
            const logsToShow = selectedDate === today ? todayLogs : (allLogs[selectedDate] || []);
            const isToday = selectedDate === today;

            logCountEl.textContent = `${logsToShow.length} entries`;

            if (logsToShow.length === 0) {
                const message = isToday
                    ? 'No logs yet<br>Complete a task to record it!'
                    : 'No logs for this day';
                timelineEl.innerHTML = `<div class="timeline-empty">${message}</div>`;
                return;
            }

            const sortedLogs = [...logsToShow].reverse();
            timelineEl.innerHTML = sortedLogs.map((log, index) => {
                const originalIndex = logsToShow.length - 1 - index;
                const deleteBtnControl = isToday
                    ? `<button class="delete-log-btn" onclick="deleteLog(${originalIndex})" title="Delete">‚úï</button>`
                    : '';
                return `
        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div class="timeline-item-header">
            <div class="timeline-content">
              <div class="timeline-time">${log.time}</div>
              <div class="timeline-task">${log.task}</div>
              <div class="timeline-praise">${log.praise}</div>
            </div>
            ${deleteBtnControl}
          </div>
        </div>
      `}).join('');
        }

        // Delete log
        function deleteLog(index) {
            if (confirm('Delete this log?')) {
                todayLogs.splice(index, 1);

                // Update allLogs
                const today = getTodayKey();
                allLogs[today] = todayLogs;
                localStorage.setItem('allLogs', JSON.stringify(allLogs));

                const totalCount = Math.max(0, parseInt(localStorage.getItem('totalCount') || '0') - 1);
                localStorage.setItem('totalCount', totalCount.toString());

                todayCountEl.textContent = todayLogs.length;
                totalCountEl.textContent = totalCount;
                renderDateTabs();
                renderTimeline();
            }
        }

        // Add log
        function addLog(task, praise) {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const log = { time: `${hours}:${minutes}`, task, praise };

            todayLogs.push(log);

            // Update allLogs
            const today = getTodayKey();
            allLogs[today] = todayLogs;
            localStorage.setItem('allLogs', JSON.stringify(allLogs));
            localStorage.setItem('lastDate', today);

            const totalCount = parseInt(localStorage.getItem('totalCount') || '0') + 1;
            localStorage.setItem('totalCount', totalCount.toString());

            todayCountEl.textContent = todayLogs.length;
            totalCountEl.textContent = totalCount;

            renderTimeline();
        }

        // Confetti
        function createConfetti() {
            const colors = ['#f39c12', '#e74c3c', '#9b59b6', '#3498db', '#2ecc71'];
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = Math.random() * 200 + 'px';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 1000);
                }, i * 30);
            }
        }

        // Preset Praise messages
        const PRESET_PRAISES = [
            "Mankind's hope!! Your efforts change the world!!üî•üî•‚ú®",
            "Cosmos is trembling at your genius!!üåå‚ú®üí´",
            "At this rate, you'll conquer the world by tomorrow!!üëëüî•üî•",
            "Legends are made like this!! A moment carved in history!!üìú‚ú®üî•",
            "Your initiative deserves to be a national treasure!!üèÜüí™‚ú®",
            "A god has descended!! Applause from Olympus!!‚ö°üëèüî•",
            "So amazing I can't find the words!! Best of the Best!!üéâüéâ‚ú®",
            "Crystal of effort!! Future you is crying with gratitude!!üò≠üíé‚ú®",
            "Beyond human limits!! Overwhelming growth!!üöÄüî•üí™",
            "Today's MVP for sure!! Standing ovation!!üëèüëèüèÜ",
            "Unbelievable!! Too cool I might fall in love!!üíïüî•‚ú®",
            "Great achievement!! Textbook material!!üìöüèÖüî•",
            "Your willpower is harder than diamonds!!üíéüí™‚ú®",
            "Stunning!! You are the chosen one!!üëë‚ú®üî•",
            "Perfect!! 100 million out of 100!!üíØüî•üéâ",
            "Incredible professionalism!! Nothing but respect!!üôá‚Äç‚ôÇÔ∏è‚ú®üí™",
            "You did it!! This sense of achievement is priceless!!üí∞üî•‚ú®",
            "Consistency is power!! You proved it!!üìàüí™üî•",
            "How far will you evolve!? Limit breaker!!üöÄüî•‚ú®",
            "Made today the best day!! Are you a genius!?üåüüéâüí™",
            "I want to follow your lead!! Respect!!üôå‚ú®üî•",
            "Step by step!! This is true strength!!üíéüí™üî•",
            "So wonderful!! The world was waiting for you!!üåç‚ú®üíï",
            "Bravo!! 3-hour standing ovation!!üëèüëèüéâ",
            "Breathtaking performance!! Gold medal class!!ü•áüî•‚ú®",
            "You beat yourself!! This is the true victory!!üèÜüí™üî•",
            "The moment daily effort blooms!! Too beautiful!!üå∏‚ú®üíé",
            "The world turns because of you!! Thank you!!üåèüíï‚ú®",
            "Strongest!! Invincible!! Champion!!üèÜüëëüî•",
            "Conquered today!! Congratulations!!üéäüéâ‚ú®",
            "So dazzling I can't look directly!!‚òÄÔ∏è‚ú®üí™",
            "Sensing a legend is born!! History has moved!!üìúüî•üéâ",
            "Every step is great!! Real respect!!üôåüí™‚ú®",
            "Conquering the universe is not a dream either!!üöÄüååüëë",
            "Cheers to your effort!! Highest!!ü•Ç‚ú®üî•",
            "Man of action!! Problematic coolness!!üòéüí™üî•",
            "Updating your personal best!! How far will you go!?üìàüî•‚ú®",
            "A hero has arrived!! Saved the town vibe!!ü¶∏‚Äç‚ôÇÔ∏è‚ú®üí™",
            "Precious...!! Your hard work is too precious!!üôèüíé‚ú®",
            "Perfect!! Flawless!!üíØüëëüî•",
        ];

        // Get Praise
        async function getPraise(task) {
            const apiKey = apiKeyInput.value.trim();

            // If no API key, pick random preset
            if (!apiKey) {
                return PRESET_PRAISES[Math.floor(Math.random() * PRESET_PRAISES.length)];
            }

            localStorage.setItem('geminiApiKey', apiKey);

            const prompt = `You are the world's most over-the-top praising BOT. No explanations or preambles. Just return one compliment.

Condition:
- Exaggeratedly praise the person who completed "${task}".
- Enthusiastically acclaim them as if they saved the world.
- Within 50 characters.
- Use 2-3 emojis.
- Use lots of "!" for high tension.
- Output ONLY the compliment.

Bad example: "Great job! Genius!" (too simple)
Good example: "Mankind's hope!! Your efforts change the world!!üî•üî•‚ú®"`;

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    }
                );

                if (!response.ok) throw new Error('API error');
                const data = await response.json();
                return data.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error(error);
                // Fallback to presets on API error
                return PRESET_PRAISES[Math.floor(Math.random() * PRESET_PRAISES.length)];
            }
        }

        // Show message
        function showMessage(text) {
            messageEl.classList.remove('show');
            setTimeout(() => {
                messageEl.textContent = text;
                messageEl.classList.add('show');
            }, 100);
        }

        // Complete button
        completeBtn.addEventListener('click', async () => {
            const task = taskInput.value.trim();
            if (!task) {
                showMessage('Please enter a task! üìù');
                return;
            }

            completeBtn.disabled = true;
            completeBtn.textContent = 'üîÑ';

            createConfetti();
            const praise = await getPraise(task);

            addLog(task, praise);
            showMessage(praise);

            taskInput.value = '';
            completeBtn.disabled = false;
            completeBtn.textContent = 'Done! üí™';
        });

        // Enter key to complete
        taskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') completeBtn.click();
        });

        // Settings toggle
        settingsToggle.addEventListener('click', () => {
            settingsSection.classList.toggle('show');
        });

        // ===== Modal Related =====

        // Initialize pickers
        function initPickers() {
            emojiPicker.innerHTML = '';
            EMOJIS.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-option';
                btn.textContent = emoji;
                btn.type = 'button';
                btn.addEventListener('click', () => {
                    selectedEmoji = emoji;
                    updatePickerSelection();
                });
                emojiPicker.appendChild(btn);
            });

            colorPicker.innerHTML = '';
            COLORS.forEach(color => {
                const btn = document.createElement('button');
                btn.className = `color-option color-${color}`;
                btn.dataset.color = color;
                btn.type = 'button';
                btn.addEventListener('click', () => {
                    selectedColor = color;
                    updatePickerSelection();
                });
                colorPicker.appendChild(btn);
            });
        }

        function updatePickerSelection() {
            document.querySelectorAll('.emoji-option').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent === selectedEmoji);
            });
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.color === selectedColor);
            });
        }

        function openAddModal() {
            editingTaskId = null;
            modalTitle.textContent = 'Add Task';
            taskNameInput.value = '';
            selectedEmoji = 'üí™';
            selectedColor = 'red';
            deleteBtn.style.display = 'none';
            updatePickerSelection();
            modal.classList.add('show');
        }

        function openEditModal(taskId) {
            const task = quickTasks.find(t => t.id === taskId);
            if (!task) return;

            editingTaskId = taskId;
            modalTitle.textContent = 'Edit Task';
            taskNameInput.value = task.label;
            selectedEmoji = task.emoji;
            selectedColor = task.color;
            deleteBtn.style.display = 'block';
            updatePickerSelection();
            modal.classList.add('show');
        }

        function closeModal() {
            modal.classList.remove('show');
        }

        function saveTask() {
            const label = taskNameInput.value.trim();
            if (!label) {
                alert('Please enter a task name');
                return;
            }

            if (editingTaskId) {
                const task = quickTasks.find(t => t.id === editingTaskId);
                if (task) {
                    task.label = label;
                    task.emoji = selectedEmoji;
                    task.color = selectedColor;
                }
            } else {
                quickTasks.push({
                    id: 'task_' + Date.now(),
                    emoji: selectedEmoji,
                    label: label,
                    color: selectedColor
                });
            }

            localStorage.setItem('quickTasks', JSON.stringify(quickTasks));
            renderQuickTasks();
            closeModal();
        }

        function deleteTask() {
            if (!editingTaskId) return;
            if (!confirm('Delete this task?')) return;

            quickTasks = quickTasks.filter(t => t.id !== editingTaskId);
            localStorage.setItem('quickTasks', JSON.stringify(quickTasks));
            renderQuickTasks();
            closeModal();
        }

        saveBtn.addEventListener('click', saveTask);
        cancelBtn.addEventListener('click', closeModal);
        deleteBtn.addEventListener('click', deleteTask);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // Copy to clipboard in Obsidian format
        function copyToClipboard() {
            const logsToShow = selectedDate === getTodayKey() ? todayLogs : (allLogs[selectedDate] || []);
            if (logsToShow.length === 0) {
                showMessage('No logs to copy');
                return;
            }

            let markdown = `## Logs for ${selectedDate}\n\n`;

            logsToShow.forEach(log => {
                markdown += `- [x] ${log.time} ${log.task}\n`;
                markdown += `  - ${log.praise}\n`;
            });

            navigator.clipboard.writeText(markdown).then(() => {
                copyBtn.textContent = '‚úÖ Copied';
                copyBtn.classList.add('copied');
                setTimeout(() => {
                    copyBtn.textContent = 'üìã Copy';
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                showMessage('Copy failed');
            });
        }

        copyBtn.addEventListener('click', copyToClipboard);

        // No Service Worker for en yet or same shared? sw.js seems generic.
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('SW registration failed:', err));
        }

        // Initialization
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        initPickers();
        loadData();
    </script>
</body>

</html>